# ==========================================
# ç¬¬ä¸€æ­¥ï¼šå¯¼å…¥å¿…è¦çš„â€œå·¥å…·åŒ…â€
# ==========================================
# random ç”¨æ¥ç”Ÿæˆéšæœºæ•°æ¨¡æ‹Ÿé”€å”®é¢
import random
# datetime ç”¨æ¥è®¾ç½® DAG çš„å¼€å§‹æ—¶é—´
from datetime import datetime
# dag å’Œ task æ˜¯ Airflow çš„æ ¸å¿ƒè£…é¥°å™¨ (TaskFlow API)
from airflow.decorators import dag, task

# ==========================================
# ç¬¬äºŒæ­¥ï¼šå®šä¹‰ DAG (ç®¡å®¶)
# ==========================================
# ä½¿ç”¨ @dag è£…é¥°å™¨å‘Šè¯‰ Airflow è¿™æ˜¯ä¸€ä¸ªå·¥ä½œæµ
@dag(
    # ç»™ DAG èµ·ä¸ªå”¯ä¸€çš„ IDï¼Œä½ åœ¨ç½‘é¡µä¸Šå°±æœè¿™ä¸ªåå­—
    dag_id="lesson1_xcom_data_flow",
    
    # å¼€å§‹æ—¥æœŸï¼šæ³¨æ„ï¼Airflow åªä¼šè¿è¡Œ start_date ä¹‹åçš„ä»»åŠ¡
    start_date=datetime(2025, 1, 1),
    
    # è°ƒåº¦é¢‘ç‡ï¼šNone ä»£è¡¨ä¸è‡ªåŠ¨è·‘ï¼Œåªå…è®¸ä½ å»ç½‘é¡µä¸Šæ‰‹åŠ¨ç‚¹ Play
    schedule="* * * * *",
    
    # è¿½èµ¶æœºåˆ¶ï¼šFalse ä»£è¡¨ä¸è¦å›å¤´å»è¡¥è·‘è¿‡å»çš„æ—¥æœŸ (æ–°æ‰‹ä¿å‘½è®¾ç½®)
    catchup=False,
    
    # æ ‡ç­¾ï¼šæ–¹ä¾¿åœ¨ UI ä¸Šç­›é€‰
    tags=["learning", "hand-coded"]
)
def data_flow_pipeline():
    """
    è¿™æ˜¯ä¸»å‡½æ•°ï¼Œé‡Œé¢å®šä¹‰äº†æ‰€æœ‰çš„ä»»åŠ¡å’Œå®ƒä»¬çš„ä¾èµ–å…³ç³»ã€‚
    """

    # ==========================================
    # ç¬¬ä¸‰æ­¥ï¼šå®šä¹‰ä»»åŠ¡ A (ç”Ÿäº§è€…)
    # ==========================================
    # ä½¿ç”¨ @task è£…é¥°å™¨ï¼ŒæŠŠä¸‹é¢è¿™ä¸ª Python å‡½æ•°å˜æˆ Airflow çš„ä¸€ä¸ªèŠ‚ç‚¹
    @task
    def get_sales_amount():
        # æ¨¡æ‹Ÿä¸šåŠ¡é€»è¾‘ï¼šéšæœºç”Ÿæˆ 100 åˆ° 1000 ä¹‹é—´çš„é”€å”®é¢
        amount = random.randint(100, 1000)
        
        print(f"ä»Šå¤©çš„é”€å”®é¢æ˜¯: ${amount}")
        
        # ã€å…³é”®ç‚¹ã€‘ï¼šè¿™é‡Œçš„ return å€¼ä¼šè¢« Airflow è‡ªåŠ¨æŠ“å–
        # å¹¶å­˜å…¥å…ƒæ•°æ®åº“ (XCom è¡¨) ä¸­ï¼Œä¾›ä¸‹æ¸¸ä»»åŠ¡ä½¿ç”¨
        return amount

    # ==========================================
    # ç¬¬å››æ­¥ï¼šå®šä¹‰ä»»åŠ¡ B (æ¶ˆè´¹è€…)
    # ==========================================
    # æ³¨æ„ï¼šè¿™ä¸ªå‡½æ•°æ¥æ”¶ä¸€ä¸ªå‚æ•° 'sales'
    @task
    def check_target(sales):
        # è®¾å®šä¸€ä¸ªè¾¾æ ‡çº¿
        target = 500
        
        print(f"æ”¶åˆ°çš„é”€å”®é¢æ•°æ®: ${sales}")
        
        # ç®€å•çš„ Python é€»è¾‘åˆ¤æ–­
        if sales > target:
            print("ğŸ‰ æ­å–œï¼ä»Šæ—¥è¾¾æ ‡ï¼(Sales > 500)")
        else:
            print("ğŸ˜­ é—æ†¾ï¼Œæœªè¾¾æ ‡... (Sales <= 500)")

    # ==========================================
    # ç¬¬äº”æ­¥ï¼šç¼–æ’ä¾èµ– (Orchestration)
    # ==========================================
    # 1. è°ƒç”¨ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œå¹¶å°†å®ƒçš„ç»“æœèµ‹å€¼ç»™å˜é‡ sales_value
    #    (æ­¤æ—¶ä»£ç å¹¶ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯ç”Ÿæˆäº†ä¸€ä¸ªä¾èµ–å¼•ç”¨)
    sales_value = get_sales_amount()
    
    # 2. è°ƒç”¨ç¬¬äºŒä¸ªä»»åŠ¡ï¼ŒæŠŠä¸Šä¸€æ­¥çš„ sales_value ä¼ è¿›å»
    #    Airflow è‡ªåŠ¨è¯†åˆ«å‡ºï¼šå¿…é¡»ç­‰ä»»åŠ¡1è·‘å®Œï¼Œæ‹¿åˆ°ç»“æœåï¼Œæ‰èƒ½è·‘ä»»åŠ¡2
    check_target(sales_value)

# ==========================================
# ç¬¬å…­æ­¥ï¼šå®ä¾‹åŒ– DAG
# ==========================================
# å¿…é¡»åœ¨æ–‡ä»¶æœ€åè°ƒç”¨ä¸€æ¬¡è¿™ä¸ªä¸»å‡½æ•°ï¼ŒAirflow æ‰èƒ½æ³¨å†Œè¿™ä¸ª DAG
data_flow_pipeline()